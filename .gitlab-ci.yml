---
stages:
- build
- test

render:
  stage: build
  image: golang
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
    - manifests
  only:
  - merge_requests
  variables:
    JSONNET_VERSION: "0.16.0"
  script:
  - go mod init dummymod
  - go get github.com/google/go-jsonnet/cmd/jsonnet@v${JSONNET_VERSION}
  - go get github.com/google/go-jsonnet/cmd/jsonnetfmt@v${JSONNET_VERSION}
  - make lint-jsonnet
  - make dashboards_out prometheus_alerts.yaml prometheus_rules.yaml

prometheus-test:
  stage: test
  image:
    name: prom/prometheus:latest
    entrypoint: [""]
  dependencies:
  - render
  needs:
  - render
  only:
  - merge_requests
  script:
  - promtool check rules manifests/prometheus_rules.yaml
  - promtool check rules manifests/prometheus_alerts.yaml
  - promtool test rules tests.yaml
